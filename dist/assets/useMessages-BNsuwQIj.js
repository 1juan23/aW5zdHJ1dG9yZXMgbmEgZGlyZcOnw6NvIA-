import{e as l,f,u as m}from"./supabase-vendor-zrCfvSZu.js";import{r as w}from"./react-vendor-C2tQq_zP.js";import{s as t}from"./index-CcM7G_HG.js";import{D as g}from"./ui-vendor-D-xBSbyO.js";function p(){return m({queryKey:["conversations"],queryFn:async()=>{const{data:{user:e}}=await t.auth.getUser();if(!e)throw new Error("N達o autenticado");const{data:r}=await t.from("instructors").select("id").eq("user_id",e.id).maybeSingle(),{data:s,error:a}=await t.from("conversations").select(`
          *,
          instructor:instructors_public!instructor_id (name, avatar_url, user_id)
        `).order("last_message_at",{ascending:!1});if(a)throw a;const n=(s||[]).filter(u=>{const o=u;return!(o.instructor_id===e.id&&o.instructor_deleted_at||o.student_id===e.id&&o.student_deleted_at)}),i=await Promise.all(n.map(async u=>{const{data:o}=await t.from("profiles").select("name, avatar_url").eq("user_id",u.student_id).maybeSingle();let d=o;if(!d){const{data:_}=await t.from("profiles_public").select("name, avatar_url").eq("user_id",u.student_id).maybeSingle();d=_}return{...u,student:d&&d.name?d:{name:"Aluno",avatar_url:null}}}));return await Promise.all(i.map(async u=>{const{count:o}=await t.from("messages").select("*",{count:"exact",head:!0}).eq("conversation_id",u.id).eq("is_read",!1).neq("sender_id",e.id);return{...u,hasUnread:(o||0)>0,unreadCount:o||0}}))}})}function b(e){const r=l();return w.useEffect(()=>{if(!e)return;const s=t.channel(`messages:${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${e}`},a=>{r.setQueryData(["messages",e],n=>n?[...n,a.new]:[a.new]),r.invalidateQueries({queryKey:["conversations"]})}).subscribe();return()=>{t.removeChannel(s)}},[e,r]),m({queryKey:["messages",e],queryFn:async()=>{const{data:{user:s}}=await t.auth.getUser();if(!s)throw new Error("N達o autenticado");const{data:a,error:n}=await t.from("messages").select("*").eq("conversation_id",e).order("created_at",{ascending:!0});if(n)throw n;const i=(a||[]).filter(c=>!c.is_read&&c.sender_id!==s.id).map(c=>c.id);return i.length>0&&(await t.from("messages").update({is_read:!0}).in("id",i),r.invalidateQueries({queryKey:["conversations"]})),a},enabled:!!e})}function C(){const e=l();return f({mutationFn:async({conversationId:r,content:s})=>{const{data:{user:a}}=await t.auth.getUser();if(!a)throw new Error("N達o autenticado");const{data:n,error:i}=await t.from("messages").insert({conversation_id:r,sender_id:a.id,content:s}).select().single();if(i)throw i;return await t.from("conversations").update({last_message_at:new Date().toISOString()}).eq("id",r),n},onSuccess:(r,s)=>{e.invalidateQueries({queryKey:["conversations"]})},onError:r=>{g.error(r.message||"Erro ao enviar mensagem")}})}function S(){const e=l();return f({mutationFn:async r=>{const{data:{user:s}}=await t.auth.getUser();if(!s)throw new Error("N達o autenticado");const{data:a}=await t.from("conversations").select("id").eq("instructor_id",r).eq("student_id",s.id).maybeSingle();if(a)return a;const{data:n,error:i}=await t.from("conversations").insert({instructor_id:r,student_id:s.id}).select().single();if(i)throw i;return n},onSuccess:()=>{e.invalidateQueries({queryKey:["conversations"]})}})}export{b as a,C as b,p as c,S as u};
