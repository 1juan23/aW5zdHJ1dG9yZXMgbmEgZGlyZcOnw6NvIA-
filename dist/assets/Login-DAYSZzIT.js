import{j as e}from"./supabase-vendor-zrCfvSZu.js";import{u as D,B as P,s as o,c as A,H as Z,F as G,C as oe,a as ne,b as le,d as ce,e as de}from"./index-CcM7G_HG.js";import{I as C}from"./input-CCzeZ9h-.js";import{L as _}from"./label-BuoQyU_D.js";import{r as m,u as me,H as W,L as J}from"./react-vendor-C2tQq_zP.js";import{l as ue,s as xe,Z as he,g as pe}from"./validations-BW1-a5ag.js";import{T as fe}from"./TwoFactorVerify-BxhcXo2e.js";import{L as K,b as ge,X as ve,g as Q,w as X,j as je,x as T,E as be,y as we}from"./ui-vendor-D-xBSbyO.js";import{u as Ne,E as ye}from"./EmailSecurityBadge-Cq55aYub.js";function Ee({mode:l,disabled:x}){const[a,c]=m.useState(null),{toast:d}=D(),j=async()=>{c("google");try{const{error:n}=await o.auth.signInWithOAuth({provider:"google",options:{redirectTo:`${window.location.origin}/`,queryParams:{access_type:"offline",prompt:"consent"}}});if(n)throw n}catch(n){d({title:"Erro ao conectar com Google",description:n.message||"Tente novamente mais tarde.",variant:"destructive"}),c(null)}};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("span",{className:"w-full border-t"})}),e.jsx("div",{className:"relative flex justify-center text-xs uppercase",children:e.jsx("span",{className:"bg-card px-2 text-muted-foreground",children:l==="login"?"ou entre com":"ou cadastre com"})})]}),e.jsxs(P,{type:"button",variant:"outline",className:"w-full gap-3 h-11 font-medium hover:bg-muted/50 transition-all",onClick:j,disabled:x||a!==null,children:[a==="google"?e.jsx(K,{className:"h-5 w-5 animate-spin"}):e.jsxs("svg",{className:"h-5 w-5",viewBox:"0 0 24 24",children:[e.jsx("path",{fill:"#4285F4",d:"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"}),e.jsx("path",{fill:"#34A853",d:"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"}),e.jsx("path",{fill:"#FBBC05",d:"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"}),e.jsx("path",{fill:"#EA4335",d:"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"})]}),e.jsx("span",{children:"Continuar com Google"})]}),e.jsxs("p",{className:"text-xs text-center text-muted-foreground",children:["Ao continuar, você concorda com nossos"," ",e.jsx("a",{href:"/termos",className:"text-accent hover:underline",children:"Termos de Uso"})," ","e"," ",e.jsx("a",{href:"/privacidade",className:"text-accent hover:underline",children:"Política de Privacidade"})]})]})}function Ce({password:l}){const x=m.useMemo(()=>[{label:"Mínimo 8 caracteres",met:l.length>=8},{label:"Letra maiúscula",met:/[A-Z]/.test(l)},{label:"Letra minúscula",met:/[a-z]/.test(l)},{label:"Número",met:/[0-9]/.test(l)},{label:"Caractere especial (!@#$%)",met:/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(l)}],[l]),a=m.useMemo(()=>{const c=x.filter(d=>d.met).length;return c<=2?{level:"weak",label:"Fraca",color:"bg-destructive"}:c<=3?{level:"medium",label:"Média",color:"bg-warning"}:c<=4?{level:"good",label:"Boa",color:"bg-accent"}:{level:"strong",label:"Forte",color:"bg-green-500"}},[x]);return l?e.jsxs("div",{className:"space-y-3 animate-fade-in",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs("div",{className:"flex justify-between items-center text-xs",children:[e.jsx("span",{className:"text-muted-foreground",children:"Força da senha:"}),e.jsx("span",{className:A("font-medium",a.level==="weak"&&"text-destructive",a.level==="medium"&&"text-yellow-600",a.level==="good"&&"text-accent",a.level==="strong"&&"text-green-500"),children:a.label})]}),e.jsx("div",{className:"h-1.5 bg-muted rounded-full overflow-hidden",children:e.jsx("div",{className:A("h-full transition-all duration-300 rounded-full",a.color),style:{width:`${x.filter(c=>c.met).length/x.length*100}%`}})})]}),e.jsx("div",{className:"grid grid-cols-2 gap-1.5",children:x.map((c,d)=>e.jsxs("div",{className:A("flex items-center gap-1.5 text-xs transition-colors",c.met?"text-green-600":"text-muted-foreground"),children:[c.met?e.jsx(ge,{className:"h-3 w-3"}):e.jsx(ve,{className:"h-3 w-3 opacity-50"}),e.jsx("span",{children:c.label})]},d))})]}):null}function Be(){const[l,x]=m.useState(!1),[a,c]=m.useState(!0),[d,j]=m.useState(!1),[n,q]=m.useState({}),[Y,I]=m.useState(!1),[w,k]=m.useState(!1),[N,S]=m.useState(0),u=me(),{toast:h}=D(),{validateEmail:V,isValidating:B,validationResult:ee,isBlocked:M,clearValidation:ae}=Ne(),[i,y]=m.useState({email:"",password:"",name:"",confirmPassword:""});m.useEffect(()=>{const s=setTimeout(async()=>{if(!i.email.includes("@")||!a)return;const r=i.email.trim().toLowerCase(),{data:p}=await o.rpc("is_account_locked",{check_email:r});p?(k(!0),S(900)):(k(!1),S(0))},500);return()=>clearTimeout(s)},[i.email,a]),m.useEffect(()=>{if(!w||N<=0)return;const t=setInterval(()=>{S(s=>s<=1?(k(!1),0):s-1)},1e3);return()=>clearInterval(t)},[w,N]);const $=t=>{const s=Math.floor(t/60),r=t%60;return`${s}:${r.toString().padStart(2,"0")}`};m.useEffect(()=>{const t=async r=>{var p;if(r!=null&&r.user){const{data:f}=await o.from("user_roles").select("role").eq("user_id",r.user.id).maybeSingle(),E=(p=r.user.user_metadata)==null?void 0:p.user_type;(f==null?void 0:f.role)==="instructor"||E==="instructor"?u("/instrutor/dashboard"):(f==null?void 0:f.role)==="admin"?u("/admin/dashboard"):u("/instrutores")}},{data:{subscription:s}}=o.auth.onAuthStateChange((r,p)=>{t(p)});return o.auth.getSession().then(({data:{session:r}})=>{t(r)}),()=>s.unsubscribe()},[u]);const te=()=>{q({});try{return a?ue.parse({email:i.email,password:i.password}):xe.parse(i),!0}catch(t){if(t instanceof he){const s={};t.errors.forEach(r=>{r.path[0]&&(s[r.path[0].toString()]=r.message)}),q(s),h({title:"Erro de validação",description:pe(t),variant:"destructive"})}return!1}},se=async t=>{var p,f,E,z,H,R,U;if(t.preventDefault(),!te())return;const s=await V(i.email);if((s==null?void 0:s.status)==="BLOQUEADO"){h({title:"Email bloqueado",description:"Este email foi bloqueado por motivos de segurança. Use outro email.",variant:"destructive"});return}if(!a&&s){if(s.score_risco>50){h({title:"Email de alto risco",description:`Score de risco: ${s.score_risco}/100. Este email não pode ser usado para cadastro.`,variant:"destructive"});return}if((p=s.reputacao)!=null&&p.virustotal&&s.reputacao.virustotal!=="limpo"&&s.reputacao.virustotal!=="sem_dados"){h({title:"Email malicioso detectado",description:`VirusTotal detectou este email como: ${s.reputacao.virustotal}`,variant:"destructive"});return}}j(!0);const r=i.email.trim().toLowerCase();try{if(a){const{data:g,error:v}=await o.rpc("is_account_locked",{check_email:r});if(v&&console.error("Error checking account lock:",v),g){h({title:"Conta bloqueada",description:"Sua conta está temporariamente bloqueada devido a múltiplas tentativas de login falhas. Tente novamente em 15 minutos.",variant:"destructive"}),j(!1);return}const{data:_e,error:O}=await o.auth.signInWithPassword({email:r,password:i.password});if(O){await o.rpc("record_login_attempt",{attempt_email:r,attempt_ip:null,attempt_success:!1});const{data:F}=await o.rpc("is_account_locked",{check_email:r});throw F&&(o.functions.invoke("send-account-locked-email",{body:{email:r,attemptCount:5,lockDurationMinutes:15}}).catch(ie=>console.error("Failed to send lock notification:",ie)),await o.rpc("log_security_event",{p_event_type:"account_locked",p_email:r,p_details:{reason:"multiple_failed_attempts"}})),O}await o.rpc("record_login_attempt",{attempt_email:r,attempt_ip:null,attempt_success:!0});const{data:L}=await o.auth.mfa.listFactors();if((f=L==null?void 0:L.totp)==null?void 0:f.some(F=>F.status==="verified")){I(!0),j(!1);return}h({title:"Login realizado!",description:"Bem-vindo de volta!"});const{data:b}=await o.from("user_roles").select("role").eq("user_id",(E=(await o.auth.getUser()).data.user)==null?void 0:E.id).maybeSingle();(b==null?void 0:b.role)==="instructor"?u("/instrutor/dashboard"):(b==null?void 0:b.role)==="admin"?u("/admin/dashboard"):u("/instrutores")}else{const{error:g}=await o.auth.signUp({email:r,password:i.password,options:{emailRedirectTo:`${window.location.origin}/`,data:{name:i.name.trim(),user_type:"student"}}});if(g)throw g;h({title:"Conta criada!",description:"Sua conta foi criada com sucesso."}),u("/instrutores")}}catch(g){let v="Ocorreu um erro. Tente novamente.";(z=g.message)!=null&&z.includes("Invalid login credentials")?v="Email ou senha incorretos.":(H=g.message)!=null&&H.includes("already registered")?v="Este email já está cadastrado.":(R=g.message)!=null&&R.includes("Invalid email")?v="Email inválido.":(U=g.message)!=null&&U.includes("Account locked")&&(v="Conta bloqueada temporariamente. Tente novamente em 15 minutos."),h({title:"Erro",description:v,variant:"destructive"})}finally{j(!1)}},re=async()=>{var s;h({title:"Login realizado!",description:"Verificação 2FA concluída."});const{data:t}=await o.from("user_roles").select("role").eq("user_id",(s=(await o.auth.getUser()).data.user)==null?void 0:s.id).maybeSingle();(t==null?void 0:t.role)==="instructor"?u("/instrutor/dashboard"):(t==null?void 0:t.role)==="admin"?u("/admin/dashboard"):u("/instrutores")};return Y?e.jsxs(e.Fragment,{children:[e.jsx(W,{children:e.jsx("title",{children:"Verificação 2FA | Instrutores na Direção"})}),e.jsxs("div",{className:"min-h-screen flex flex-col bg-background",children:[e.jsx(Z,{}),e.jsx("main",{className:"flex-1 flex items-center justify-center py-12 px-4",children:e.jsx(fe,{onSuccess:re,onCancel:()=>{I(!1),o.auth.signOut()}})}),e.jsx(G,{})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(W,{children:[e.jsxs("title",{children:[a?"Entrar":"Criar conta"," | Instrutores na Direção"]}),e.jsx("meta",{name:"description",content:"Faça login ou crie sua conta para encontrar os melhores instrutores de direção da sua região."})]}),e.jsxs("div",{className:"min-h-screen flex flex-col bg-gradient-to-br from-background via-background to-primary/5",children:[e.jsx(Z,{}),e.jsx("main",{className:"flex-1 flex items-center justify-center py-12 px-4",children:e.jsxs("div",{className:"w-full max-w-md",children:[e.jsxs("div",{className:"text-center mb-8 animate-fade-in",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-gradient-to-br from-primary to-primary/80 text-primary-foreground mb-4 shadow-lg shadow-primary/20",children:e.jsx(Q,{className:"h-10 w-10"})}),e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:a?"Bem-vindo de volta!":"Crie sua conta"}),e.jsx("p",{className:"text-muted-foreground mt-2 max-w-xs mx-auto",children:a?"Entre para continuar buscando instrutores":"Cadastre-se para encontrar o instrutor ideal"})]}),e.jsxs(oe,{variant:"elevated",className:"backdrop-blur-sm border-border/50 animate-fade-in-up",children:[e.jsxs(ne,{className:"space-y-1 pb-4",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[e.jsx(X,{className:"h-5 w-5 text-green-500"}),e.jsx("span",{className:"text-xs text-green-600 font-medium",children:"Login Seguro"})]}),e.jsx(le,{className:"text-xl text-center",children:a?"Entrar na conta":"Criar nova conta"}),e.jsx(ce,{className:"text-center",children:a?"Use seu email e senha para entrar":"Preencha os dados abaixo para se cadastrar"})]}),e.jsxs(de,{children:[e.jsxs("form",{onSubmit:se,className:"space-y-4",children:[!a&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"name",children:"Nome completo"}),e.jsx(C,{id:"name",type:"text",placeholder:"Seu nome",value:i.name,onChange:t=>y({...i,name:t.target.value}),required:!a,disabled:d,className:n.name?"border-destructive":""}),n.name&&e.jsx("p",{className:"text-xs text-destructive",children:n.name})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"email",children:"Email"}),e.jsxs("div",{className:"relative",children:[e.jsx(je,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(C,{id:"email",type:"email",placeholder:"seu@email.com",className:`pl-10 ${n.email||M?"border-destructive":""}`,value:i.email,onChange:t=>{y({...i,email:t.target.value}),ae()},onBlur:()=>{i.email.includes("@")&&V(i.email)},required:!0,disabled:d||B})]}),e.jsx(ye,{isValidating:B,result:ee}),n.email&&e.jsx("p",{className:"text-xs text-destructive",children:n.email})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"password",children:"Senha"}),e.jsxs("div",{className:"relative",children:[e.jsx(T,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(C,{id:"password",type:l?"text":"password",placeholder:"••••••••",className:`pl-10 pr-10 ${n.password?"border-destructive":""}`,value:i.password,onChange:t=>y({...i,password:t.target.value}),required:!0,disabled:d}),e.jsx("button",{type:"button",onClick:()=>x(!l),className:"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground",children:l?e.jsx(be,{className:"h-4 w-4"}):e.jsx(we,{className:"h-4 w-4"})})]}),n.password&&e.jsx("p",{className:"text-xs text-destructive",children:n.password}),!a&&i.password&&e.jsx(Ce,{password:i.password})]}),!a&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"confirmPassword",children:"Confirmar senha"}),e.jsxs("div",{className:"relative",children:[e.jsx(T,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(C,{id:"confirmPassword",type:l?"text":"password",placeholder:"••••••••",className:`pl-10 ${n.confirmPassword?"border-destructive":""}`,value:i.confirmPassword,onChange:t=>y({...i,confirmPassword:t.target.value}),required:!a,disabled:d})]}),n.confirmPassword&&e.jsx("p",{className:"text-xs text-destructive",children:n.confirmPassword})]}),a&&e.jsx("div",{className:"flex items-center justify-end",children:e.jsx(J,{to:"/recuperar-senha",className:"text-sm text-accent hover:underline",children:"Esqueceu a senha?"})}),e.jsx(P,{type:"submit",size:"lg",className:"w-full",disabled:d||a&&w||M,children:d?e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"mr-2 h-4 w-4 animate-spin"}),"Processando..."]}):w&&a?e.jsxs(e.Fragment,{children:["Conta bloqueada (",$(N),")"]}):a?"Entrar":"Criar conta"}),w&&a&&e.jsxs("p",{className:"text-xs text-center text-destructive mt-2",children:["Sua conta está bloqueada por múltiplas tentativas de login falhas. Aguarde ",$(N)," para tentar novamente."]})]}),e.jsx("div",{className:"mt-6",children:e.jsx(Ee,{mode:a?"login":"signup",disabled:d})}),e.jsx("div",{className:"mt-6 text-center",children:e.jsxs("p",{className:"text-sm text-muted-foreground",children:[a?"Não tem uma conta?":"Já tem uma conta?",e.jsx("button",{type:"button",onClick:()=>c(!a),className:"ml-1 text-accent hover:underline font-medium",disabled:d,children:a?"Cadastre-se":"Entre aqui"})]})}),e.jsx("hr",{className:"my-6"}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"É instrutor de direção?"}),e.jsx(J,{to:"/instrutor/login",children:e.jsxs(P,{variant:"outline",className:"w-full gap-2 hover:bg-primary hover:text-primary-foreground transition-all",children:[e.jsx(Q,{className:"h-4 w-4"}),"Acessar área do instrutor"]})})]})]})]}),e.jsxs("div",{className:"mt-6 flex justify-center gap-6 text-xs text-muted-foreground animate-fade-in",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(X,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{children:"Dados criptografados"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(T,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{children:"Conexão segura"})]})]})]})}),e.jsx(G,{})]})]})}export{Be as default};
